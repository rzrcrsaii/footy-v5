## ğŸŒ³ **Footy-Brain v5 â€” Eksiksiz klasÃ¶r/dosya aÄŸacÄ±**

> *SatÄ±r sonundaki `â‡’ â€¦` notlarÄ± ilgili **RapidAPI endpoint(ler)** veya Ã¶zel amacÄ± gÃ¶sterir.*
> *Dosya/klasÃ¶r yoksa â†’ **ekle** demen yeter â€“ modÃ¼ler tasarÄ±m buna gÃ¶re Ã¶lÃ§eklenir.*

```text
footy-brain/
â”œâ”€â”€ .env.example
â”œâ”€â”€ pyproject.toml                    # Poetry (Python 3.11 pkgâ€™leri)
â”œâ”€â”€ README.md                         # quick-start + geniÅŸletme
â”œâ”€â”€ LICENSE                           # MIT
â”œâ”€â”€ package.json                      # turborepo kÃ¶kÃ¼
â”œâ”€â”€ pnpm-workspace.yaml
â”œâ”€â”€ docker-compose.yml                # tÃ¼m servisler
â”‚
â”œâ”€â”€ /infra
â”‚   â”œâ”€â”€ k8s/                          # deployment yamllarÄ±
â”‚   â”œâ”€â”€ helm/                         # helm chart
â”‚   â”œâ”€â”€ grafana/                      # Timescale & worker dashboardâ€™larÄ±
â”‚   â””â”€â”€ github-actions/
â”‚       â””â”€â”€ ci.yml                    # lint â€¢ test â€¢ build â€¢ push â€¢ helm-lint
â”‚
â”œâ”€â”€ /config
â”‚   â”œâ”€â”€ app.yml                       # JWT, DB DSN, RapidAPI key, cache
â”‚   â”œâ”€â”€ leagues.yml                   # takib-edilecek {Ã¼lke,lig,season}
â”‚   â””â”€â”€ workers.yml                   # cron & poll frekans tanÄ±mlarÄ±
â”‚
â”œâ”€â”€ /database
â”‚   â”œâ”€â”€ ddl/
â”‚   â”‚   â”œâ”€â”€ 00_dim_tables.sql         # country, league, â€¦, bet_def_*
â”‚   â”‚   â”œâ”€â”€ 10_fact_tables.sql        # fixture, prematch*, live_*_tick â€¦
â”‚   â”‚   â”œâ”€â”€ 20_continuous_aggs.sql    # live_odds_tick_ohlc vb.
â”‚   â”‚   â””â”€â”€ 99_retention_policies.sql # Timescale retention + compress
â”‚   â””â”€â”€ seeds/
â”‚       â””â”€â”€ bootstrap_static.sql      # ilkin Ã¼lke-lig-bet defs
â”‚
â”œâ”€â”€ /tools                 # âœ… **TÃœM** RapidAPI wrapperâ€™larÄ± + iskelet
â”‚   â”œâ”€â”€ template_wrapper.py            # â€œyeni endpointâ€ ÅŸablonu
â”‚   â”œâ”€â”€ api_config.py                  # ortak header + limiter
â”‚   â”œâ”€â”€ base_service.py                # GET/params/helper
â”‚   â”œâ”€â”€ error_handler.py
â”‚   â”œâ”€â”€ countries_service.py                 â‡’  /countries
â”‚   â”œâ”€â”€ leagues_txt_service.py               â‡’  /leagues
â”‚   â”œâ”€â”€ seasons_service.py                   â‡’  /leagues/seasons
â”‚   â”œâ”€â”€ fixtures_service.py                  â‡’  /fixtures?date | /live
â”‚   â”œâ”€â”€ fixtures_round_service.py            â‡’  /fixtures/round
â”‚   â”œâ”€â”€ fixture_events_service.py            â‡’  /fixtures/events
â”‚   â”œâ”€â”€ fixture_statistics_service.py        â‡’  /fixtures/statistics
â”‚   â”œâ”€â”€ fixture_playerstatistics_service.py  â‡’  /fixtures/playerstatistics
â”‚   â”œâ”€â”€ fixture_lineups_service.py           â‡’  /fixtures/lineups
â”‚   â”œâ”€â”€ fixture_h2h_service.py               â‡’  /fixtures/h2h
â”‚   â”œâ”€â”€ odds_live_service.py                 â‡’  /odds/live
â”‚   â”œâ”€â”€ odds_live_bets_service.py            â‡’  /odds/live/bets
â”‚   â”œâ”€â”€ prematch_odds_service.py             â‡’  /odds
â”‚   â”œâ”€â”€ prematch_mapping_service.py          â‡’  /odds/mapping
â”‚   â”œâ”€â”€ prematch_bookmakers_service.py       â‡’  /prematch/bookmakers
â”‚   â”œâ”€â”€ prematch_bets_service.py             â‡’  /prematch/bets
â”‚   â”œâ”€â”€ injuries_service.py                  â‡’  /injuries
â”‚   â”œâ”€â”€ player_profiles_service.py           â‡’  /players
â”‚   â”œâ”€â”€ player_squads_service.py             â‡’  /players/squads
â”‚   â”œâ”€â”€ player_statistics_service.py         â‡’  /players/statistics
â”‚   â”œâ”€â”€ standings_service.py                 â‡’  /standings
â”‚   â”œâ”€â”€ team_countries_service.py            â‡’  /teams/countries
â”‚   â”œâ”€â”€ teamsinfo_service.py                 â‡’  /teams
â”‚   â”œâ”€â”€ team_statistics_service.py           â‡’  /teams/statistics
â”‚   â”œâ”€â”€ timezone_service.py                  â‡’  /timezone
â”‚   â””â”€â”€ (future wrappers buraya eklenir)
â”‚
â”œâ”€â”€ /apps
â”‚   â”œâ”€â”€ api-server/               # ğŸ›  FastAPI mikro-Ã§ekirdek
â”‚   â”‚   â”œâ”€â”€ main.py               # boot: cfg + DB + Celery + routers
â”‚   â”‚   â”œâ”€â”€ deps.py               # auth & db session
â”‚   â”‚   â”œâ”€â”€ plugin_loader.py      # /tools/*_service.py oto-discover
â”‚   â”‚   â”œâ”€â”€ tasks.py              # Celery gÃ¶revleri (pollers, finalizerâ€¦)
â”‚   â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”‚   â”œâ”€â”€ init.py           # DDL â€¢ cont-agg â€¢ retention â€¢ seed
â”‚   â”‚   â”‚   â””â”€â”€ models.py         # SQLModel tablolarÄ±
â”‚   â”‚   â”œâ”€â”€ realtime/
â”‚   â”‚   â”‚   â”œâ”€â”€ listener.py       # pgmq â†’ Redis pub
â”‚   â”‚   â”‚   â””â”€â”€ websocket.py      # /ws/live/{fixtureId}
â”‚   â”‚   â””â”€â”€ routers/
â”‚   â”‚       â”œâ”€â”€ fixtures.py       â‡’  SELECT fixture & iliÅŸkili tablolar
â”‚   â”‚       â”œâ”€â”€ live.py           â‡’  anlÄ±k odds/events feed
â”‚   â”‚       â”œâ”€â”€ prematch.py       â‡’  prematch_ODDS snapshot API
â”‚   â”‚       â”œâ”€â”€ cronjobs.py       â‡’  CRUD workers + Celery beat sync
â”‚   â”‚       â”œâ”€â”€ settings.py       â‡’  leagues.yml Â· bet defs Â· workers.yml
â”‚   â”‚       â””â”€â”€ plugins.py        â‡’  wrapper metadata / load - add
â”‚   â”‚
â”‚   â”œâ”€â”€ live-worker/              # âš¡ 5-10 s ingest dÃ¶ngÃ¼sÃ¼
â”‚   â”‚   â”œâ”€â”€ worker.py             # odds_live/events/stats â†’ live_*_tick
â”‚   â”‚   â””â”€â”€ conf.yml              # internal bet-id eÅŸlemesi
â”‚   â”‚
â”‚   â”œâ”€â”€ frame-worker/             # ğŸ•‘ 1 dk Ã¶zet composer
â”‚   â”‚   â””â”€â”€ frame_worker.py       # live ticks â†’ match_live_frame
â”‚   â”‚
â”‚   â””â”€â”€ web-dashboard/            # ğŸ’» Next.js 14 + Tailwind + shadcn/ui
â”‚       â”œâ”€â”€ app/
â”‚       â”‚   â”œâ”€â”€ layout.tsx
â”‚       â”‚   â”œâ”€â”€ page.tsx                # Dashboard (bugÃ¼n canlÄ±)
â”‚       â”‚   â”œâ”€â”€ fixtures/               # tarih seÃ§ â€¢ server actions
â”‚       â”‚   â”œâ”€â”€ live/                   # odds WS + events timeline
â”‚       â”‚   â”œâ”€â”€ cron-settings/          # workers.yml CRUD
â”‚       â”‚   â”œâ”€â”€ ingest-settings/        # leagues.yml CRUD
â”‚       â”‚   â”œâ”€â”€ plugins/                # wrapper registry UI
â”‚       â”‚   â””â”€â”€ openai40/               # deneme playground
â”‚       â””â”€â”€ lib/
â”‚           â”œâ”€â”€ useLiveOdds.ts          # WS hook
â”‚           â”œâ”€â”€ auth.ts                 # NextAuth
â”‚           â””â”€â”€ api.ts                  # TanStack Query client
â”‚
â””â”€â”€ docker-compose.yml (servisler)
    â”œâ”€â”€ pg                 # Timescale 2.13 / PG 16
    â”œâ”€â”€ redis
    â”œâ”€â”€ api
    â”œâ”€â”€ celery-worker
    â”œâ”€â”€ celery-beat
    â”œâ”€â”€ live-worker
    â”œâ”€â”€ frame-worker
    â”œâ”€â”€ pgmq-listener
    â””â”€â”€ web
```

---

### 2ï¸âƒ£  **AkÄ±ÅŸ & gÃ¶rev haritasÄ±**

| AÅŸama / Worker         | Ana Wrapper â‡’ Endpoint(s)                        | YazdÄ±ÄŸÄ±/SiltiÄŸi tablo    | Frekans (varsayÄ±lan) | Ayarlanabilir?\*   |
| ---------------------- | ------------------------------------------------ | ------------------------ | -------------------- | ------------------ |
| **Bootstrap static**   | countries, leagues, teamsinfoâ€¦                   | boyut tablolarÄ±          | elle + haftalÄ±k      | `workers.yml`      |
| **fixtures\_poller**   | `fixtures_service` â‡’ /fixtures?date              | `fixture`                | gÃ¼nde 1 (00:05)      | âœ“â€ƒcron             |
| **prematch\_snapshot** | `prematch_odds_service` â‡’ /odds                  | `prematch_odds_snapshot` | 3 sa                 | âœ“â€ƒcron             |
| **live\_loop**         | odds\_live / events / statistics                 | live\_\*\_tick           | 7 sn                 | âœ“ poll\_every\_sec |
| **frame\_maker**       | *(internal SQL)*                                 | match\_live\_frame       | 60 sn                | âœ“â€ƒcron             |
| **finalizer**          | statistics + events (final) / prematch (closing) | match\_result, stats     | status = FT trigger  | oto                |
| **weekly\_refresh**    | injuries, standings, player\_profiles â€¦          | dim & lookup             | pazar 03:00          | âœ“â€ƒcron             |

\* `/cron-settings` sayfasÄ±ndan **anÄ±nda** update â‡’ Celery beat + workers.yml.

---

### 3ï¸âƒ£  **KonfigÃ¼rasyon dosyalarÄ±**

```yaml
# config/app.yml  (Ã¶r)
jwt:
  secret_key: "${JWT_SECRET}"
rapidapi:
  key: "${RAPIDAPI_KEY}"
  max_rps: 6
database:
  dsn: "postgresql://footy:${DB_PW}@pg:5432/footy"
retention_days:
  live_odds_tick: 30
  live_event_tick: 90
cache:
  redis_url: "redis://redis:6379/0"
```

`leagues.yml` â€“ UI seÃ§er, live-worker filtreler
`workers.yml` â€“ hem Celery beat hem UI cron-editor iÃ§in tek kaynak.

---

### 4ï¸âƒ£  **Neden bu yapÄ± â€œboÅŸluksuzâ€?**

| Ä°htiyaÃ§                          | KlasÃ¶r/dosya / modÃ¼l                            | AÃ§Ä±klama kÄ±sa                                  |
| -------------------------------- | ----------------------------------------------- | ---------------------------------------------- |
| **MaÃ§ Ã¶ncesi** tÃ¼m snapshotâ€™lar  | prematch\_\* wrapperâ€™larÄ± + prematch\_worker    | aÃ§Ä±lÄ±ÅŸ/kapanÄ±ÅŸ + ara snapshot                  |
| **MaÃ§ iÃ§i** ham tick + anlÄ±k WS  | live-worker â†’ Timescale â†’ pgmq â†’ WS             | 5-10 s ingest, 1 dk agg, anÄ±nda WebSocket push |
| **MaÃ§ sonrasÄ±** sonuÃ§ & FT stats | finalizer task + match\_result/stats tablolar   | status=FT tetiklenince                         |
| **Ã‡ift-DB** (ham vs Ã¶zet)        | live\_\*\_tick (retention) & match\_live\_frame | ham 30-90 gÃ¼n, Ã¶zet sonsuz                     |
| **Frekans ayarÄ±** dinamik        | workers.yml + /cron-settings UI                 | cron/poll editable                             |
| **Lig/Ã¼lke/bet seÃ§imi** dinamik  | leagues.yml + /ingest-settings UI               | canlÄ± ingestâ€™i filtreler                       |
| **Yeni endpoint ekleme**         | template\_wrapper.py + /plugins router+UI       | plug-n-play RapidAPI sarmalayÄ±cÄ±               |
| **GeniÅŸletilebilir UI**          | Next.js 14 (/app) dizin-bazlÄ± routing           | yeni sayfa klasÃ¶rÃ¼ â‡’ anÄ±nda rota               |
| **Scale-out ready**              | Docker Compose â†’ k8s helm chart                 | aynÄ± klasÃ¶r, farklÄ± ortam                      |

---

### 5ï¸âƒ£  **Bir sonraki hamle**

1. **â€œOnaylÄ±yorumâ€** diye cevapla â†’ `design_prompt.md`â€™yi canvasâ€™a atÄ±yorum.
2. Ä°stersen README, DDL veya herhangi bir modÃ¼lÃ¼n â€œmini detay-yakalaâ€ ekine gidebiliriz.
3. ArdÄ±ndan **`augmentcode generate design_prompt.md`** komutu ile bÃ¼tÃ¼n iskelet kod senin repoâ€™na dÃ¶kÃ¼lmeye hazÄ±r ğŸš€

*Hangi satÄ±r hÃ¢lÃ¢ eksik gÃ¶rÃ¼nÃ¼yorsa Ã§ekinmeden sÃ¶yle â€“ dÃ¼zeltip son hÃ¢le getiririz.*
<!-- ############  ğŸ”§ Footy-Brain Monorepo â€” AUGMENTCODE JOB (v5 FINAL)  ############ -->

You are ChatGPT-o3 **inside the augmentcode tool**.  
Your task: generate a **production-ready boilerplate** that implements the *entire* Footy-Brain v5 architecture described above.

---

## 0. Golden rules (â€¼ï¸ read first)
1. **Mirror the exact directory tree** given earlierâ€”no extra, no missing paths.
2. Every file must compile / build *out-of-the-box* with  
   `docker compose up -d && pnpm --filter web-dashboard dev`.
3. No hard-coded secrets; read from **env vars** or the YAML configs in `/config`.
4. Deep business logic may be shortened with `# TODO:` comments, **but interfaces, data flow, and wiring must be concrete and working**.
5. Language / version pins:  
   * Python 3.11 â€¢ Poetry â€¢ FastAPI â‰¥ 0.110 â€¢ SQLModel 0.0.16  
   * Node 18 â€¢ pnpm â€¢ Next.js 14 â€¢ Tailwind v3 â€¢ shadcn/ui  
   * TimescaleDB 2.13 / PG 16 â€¢ Redis 7 â€¢ Celery 5+

---

## 1.  Python back-end

### 1.1  `apps/api-server`
* **`main.py`**  
  â€“ Load `.env` and YAMLs (`config/app.yml`, `leagues.yml`, `workers.yml`).  
  â€“ Initialise **asyncpg** pool.  
  â€“ Execute all SQL files in `/database/ddl` **in numeric order**; create continuous aggregates & retention; run seeds if `country` is empty.  
  â€“ Start **plugin_loader** â†’ auto-discover every file ending with `_service.py` under `/tools`.  
  â€“ Spin up **Celery Beat** with schedules from `workers.yml` (fallback DB table `cronjobs`).  
  â€“ Mount routers & WebSocket route; add JWT auth; protect `/docs`.

* **Routers** (`/apps/api-server/routers`)  
  `fixtures.py`, `live.py`, `prematch.py`, `cronjobs.py`, `settings.py`, `plugins.py` â€“ expose REST endpoints exactly matching UI needs.

* **Realtime layer** (`/apps/api-server/realtime`)  
  `listener.py` listens **pgmq**, publishes JSON payloads to Redis channel `"live-feed"`;  
  `websocket.py` consumes that channel and multicasts to all `/ws/live/{fixtureId}` clients.

* **`tasks.py`** â€“ register Celery jobs:  
  `fixture_poller`, `prematch_snapshot`, `live_manager_trigger`, `frame_maker`, `finalizer`, `weekly_refresh`, `cold_archive`.

* **`db/`**  
  `init.py` (DDL orchestration) Â· `models.py`(SQLModel mappings, incl. Timescale hypertable table_args).

### 1.2  Workers

* **`apps/live-worker/worker.py`**  
  â€“ Read polling interval & endpoints from `workers.yml`.  
  â€“ For every live fixture (filtered by `leagues.yml`) call:  
    `/odds/live`, `/fixtures/events`, `/fixtures/statistics`.  
  â€“ Bulk-COPY rows into `live_odds_tick`, `live_event_tick`, `live_stat_tick`.  
  â€“ Detect YAML change (`watchdog`) â‡’ soft reload.

* **`apps/frame-worker/frame_worker.py`**  
  â€“ Every 60 s execute the SQL that materialises `match_live_frame` from tick tables.

---

## 2.  RapidAPI wrapper plug-ins (`/tools`)

* Provide a **concrete implementation** for every file listed in the tree; each must inherit `base_service.BaseService` and expose a `fetch(**params) -> dict` method.
* **`template_wrapper.py`** â€“ minimal class ready to copy/paste.
* `api_config.py` â€“ stores base URL, key, rate-limit semaphore (6 rps default).
* `error_handler.py` â€“ raise typed Exceptions on non-200 or quota issues.

---

## 3.  Front-end (`/apps/web-dashboard`)

* Use **Next.js 14 App Router**, Tailwind, shadcn/ui, **TanStack Query**.
* Implement pages & components exactly under the folders in the tree:
  * `/` â€“ Dashboard with â€œTodayâ€™s Live Fixturesâ€ table + OHLC sparkline (Recharts).
  * `/fixtures` â€“ date picker + server-side filtered list.
  * `/live/[fixtureId]` â€“ header (score), odds table (WebSocket), event timeline, stats chart.
  * `/cron-settings` â€“ editable grid of `workers.yml` (cron vs poll, interval-seconds, enabled). Use `cronstrue` for cron preview.
  * `/ingest-settings` â€“ country â†’ league cascading select, multi-select bet types; PATCH â†’ `/api/settings/ingest`.
  * `/plugins` â€“ list discovered wrappers, status badge; show code snippet from `template_wrapper.py` to scaffold new one.
  * `/openai40` â€“ blank playground page (placeholder).
* `lib/useLiveOdds.ts` â€“ thin WS hook (auto-reconnect, JSON parse, fixture filter).

---

## 4.  Docker & DevOps

* **`docker-compose.yml`**  
  services: `pg`, `redis`, `api`, `celery-worker`, `celery-beat`, `live-worker`, `frame-worker`, `pgmq-listener`, `web`; all with healthchecks and proper `depends_on`.  
  Mount `/config` into workers as read-only volume, so YAML edits trigger reload.

* **CI / CD (`infra/github-actions/ci.yml`)**  
  matrix: {python, node}.  
  steps: ruff lint â†’ eslint lint â†’ pytest â†’ jest â†’ docker build for every service â†’ push to GHCR â†’ helm-lint.

* **Helm chart** in `/infra/helm/footy-brain` â€“ values for image tags, env secrets, otel side-car toggle.

---

## 5.  Quality gates

* All modules pass `mypy --strict` and `ruff --select all`.
* `docker compose exec pg psql -c "\dt"` lists every table created by DDLs.
* Front-end `pnpm prettier --check` = clean.

---

Deliver the scaffold **exactly** as specified.  
Mark any deeper, domain-specific computation with `# TODO:` commentsâ€”but everything else (config loading, DB init, Celery wiring, WebSocket broadcast, basic UI pages) **must work out of the box**.

<!-- ############  END OF JOB  ############ -->
